#!/bin/bash

user="elastico"
group="$(id -gn $user)"
java_heap_size=${JAVA_HEAP_SIZE:-"256"}
echo "INFO - Java Heap Size = ${java_heap_size}M"
elastic_opts="$@"

conf_dir=${conf_dir:-/etc/elasticsearch}
home_dir=${home_dir:-/var/lib/elasticsearch}
default_data_dir=/var/lib/elasticsearch/data
default_plugins_dir="$home_dir/plugins"
default_logs_dir="/var/log/elasticsearch/"
default_script_dir="$conf_dir/scripts"
default_work_dir="/var/tmp/elasticsearch"

java_opts="
    -server
    -XX:+DisableExplicitGC
    -Djava.awt.headless=true
    -Dfile.encoding=utf-8
    -Xms${java_heap_size}M -Xmx${java_heap_size}M
    ${java_max_direct_mem_size:+"-XX:MaxDirectMemorySize=$java_max_direct_mem_size"}
    -Djna.nosys=true
    $java_opts"

lib_dir="/usr/share/java/elasticsearch/lib"
ES_JAR=$(ls $lib_dir/elasticsearch-*.jar)
if [[ -z $ES_JAR ]]; then
  echo "ERROR - can't find elasticsearch-version.jar"
  exit 1
fi
classpath="$ES_JAR:$lib_dir/*"

command="java"
command_args="
    $java_opts
    -Des.path.conf=$conf_dir
    -Des.path.home=$home_dir
    -Des.default.path.data=$default_data_dir
    -Des.default.path.plugins=$default_plugins_dir
    -Des.default.path.work=$default_work_dir
    -Des.default.path.logs=$default_logs_dir
    -Des.default.path.script=$default_script_dir
    -cp $classpath
    org.elasticsearch.bootstrap.Elasticsearch start
    $elastic_opts"

if [ -n "$max_fd" ]; then
    ulimit -n "$max_fd" && echo "Max open filedescriptors: $max_fd"
fi

exec "$command" $command_args

